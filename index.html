<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro de Cliente e Servi√ßo - Gera√ß√£o de Contrato</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Apenas estilo m√≠nimo para o bot√£o que exibimos ap√≥s gerar */
    .button-link {
      display: inline-block;
      margin: 6px 6px 0 0;
      background-color: #007bff;
      color: #fff;
      padding: 8px 14px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
    }
    .button-link:hover { background-color: #0056b3; }
    #form-status { margin-top: 12px; font-weight: 600; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header-area">
      <img src="Imagens/LOGO PNG.png" alt="Logo do Escrit√≥rio" class="logo">
      <h1>Cadastro de Cliente e Servi√ßo</h1>
    </header>

    <!-- FORMUL√ÅRIO - mantenha o action apontando para sua implanta√ß√£o /exec -->
    <form id="apps-script-form"
      action="https://script.google.com/macros/s/AKfycby-qrbWyfmFPOedWa-j_-IBP64qStfh_IB_xc-Zl9CjtncowahXCrW_5TMyKJYEdeNx_w/exec"
      method="POST"
      target="hidden_iframe">

      <!-- DADOS PESSOAIS -->
      <fieldset>
        <legend>Dados Pessoais</legend>
        <div class="form-row">
          <div class="form-group">
            <label for="nome_cliente">Nome do Cliente:</label>
            <input type="text" id="nome_cliente" name="entry.1508477462" required>
          </div>
          <div class="form-group">
            <label for="profissao">Profiss√£o:</label>
            <input type="text" id="profissao" name="entry.1769587082" required>
          </div>
          <div class="form-group">
            <label for="estado_civil">Estado Civil:</label>
            <select id="estado_civil" name="entry.576137551" required>
              <option value="">Selecione</option>
              <option>Solteiro(a)</option>
              <option>Casado(a)</option>
              <option>Divorciado(a)</option>
              <option>Vi√∫vo(a)</option>
              <option>Uni√£o Est√°vel</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="nacionalidade">Nacionalidade:</label>
            <input type="text" id="nacionalidade" name="entry.1559950514" value="Brasileira" required>
          </div>
          <div class="form-group">
            <label for="rg">RG:</label>
            <input type="text" id="rg" name="entry.501155755" required>
          </div>
          <div class="form-group">
            <label for="orgao_emissor">√ìrg√£o Emissor:</label>
            <input type="text" id="orgao_emissor" name="entry.1959265103" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="cpf_cnpj">CPF/CNPJ:</label>
            <input type="text" id="cpf_cnpj" name="entry.284561114" required>
          </div>
          <div class="form-group">
            <label for="telefone">Telefone:</label>
            <input type="text" id="telefone" name="entry.1963614406">
          </div>
          <div class="form-group">
            <label for="email">E-mail:</label>
            <input type="email" id="email" name="entry.1454513052">
          </div>
        </div>
      </fieldset>

      <!-- ENDERE√áO -->
      <fieldset>
        <legend>Endere√ßo</legend>
        <div class="form-row">
          <div class="form-group form-group-cep">
            <label for="cep">CEP:</label>
            <input type="text" id="cep" name="entry.146264210" required>
          </div>
          <div class="form-group form-group-rua">
            <label for="rua">Rua / Logradouro:</label>
            <input type="text" id="rua" name="entry.1081335762">
          </div>
          <div class="form-group form-group-numero">
            <label for="numero">N¬∫:</label>
            <input type="text" id="numero" name="entry.1325490080">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="bairro">Bairro:</label>
            <input type="text" id="bairro" name="entry.1507498330">
          </div>
          <div class="form-group">
            <label for="cidade">Cidade:</label>
            <input type="text" id="cidade" name="entry.1265615616">
          </div>
          <div class="form-group form-group-uf">
            <label for="estado">UF:</label>
            <input type="text" id="estado" name="entry.638627271">
          </div>
          <div class="form-group">
            <label for="complemento">Complemento:</label>
            <input type="text" id="complemento" name="entry.1735025979">
          </div>
        </div>
      </fieldset>

      <!-- SERVI√áO -->
      <fieldset>
        <legend>Servi√ßo</legend>
        <div class="form-group">
          <label for="descricao_servicos">Descri√ß√£o dos Servi√ßos:</label>
          <textarea id="descricao_servicos" name="entry.26710726" rows="4" required></textarea>
        </div>
        <div class="form-group">
          <label for="honorarios_advocaticios">Honor√°rios Advocat√≠cios (por extenso):</label>
          <textarea id="honorarios_advocaticios" name="entry.1471527232" rows="2" required></textarea>
        </div>
      </fieldset>

      <button type="submit" id="submit-button">Gerar Contrato e Salvar</button>
      <p id="form-status"></p>
      <div id="download-area"></div>
    </form>
  </div>

  <!-- Iframe oculto para receber a resposta -->
  <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

  <script>
    // ==== Elementos =====
    const form = document.getElementById('apps-script-form');
    const iframe = document.getElementById('hidden_iframe');
    const statusMessage = document.getElementById('form-status');
    const downloadArea = document.getElementById('download-area');
    const submitButton = document.getElementById('submit-button');

    // ===== M√°scaras / transforma√ß√µes originais =====
    const applyMask = (input, pattern) => {
      let value = input.value.replace(/\D/g, '');
      let maskedValue = '';
      let valueIndex = 0;
      let patternIndex = 0;
      while (valueIndex < value.length && patternIndex < pattern.length) {
        maskedValue += (pattern[patternIndex] === '#') ? value[valueIndex++] : pattern[patternIndex];
        patternIndex++;
      }
      return maskedValue;
    };

    // Nome em caps
    document.getElementById('nome_cliente').addEventListener('input', e => {
      e.target.value = e.target.value.toUpperCase();
    });

    // RG
    document.getElementById('rg').addEventListener('input', e => {
      e.target.value = applyMask(e.target, '##.###.###-#');
    });

    // CPF/CNPJ (dupla m√°scara)
    document.getElementById('cpf_cnpj').addEventListener('input', e => {
      let v = e.target.value.replace(/\D/g, '');
      if (v.length <= 11) {
        e.target.value = applyMask(e.target, '###.###.###-##');
      } else {
        e.target.value = applyMask(e.target, '##.###.###/####-##');
      }
    });

    // CEP
    document.getElementById('cep').addEventListener('input', e => {
      e.target.value = applyMask(e.target, '#####-###');
    });

    // Telefone (com DDD)
    document.getElementById('telefone').addEventListener('input', e => {
      let v = e.target.value.replace(/\D/g, '');
      e.target.value = v.length <= 10 ? applyMask(e.target, '(##) ####-####') : applyMask(e.target, '(##) #####-####');
    });

    // ViaCEP - preenche rua, bairro, cidade, estado
    document.getElementById('cep').addEventListener('blur', () => {
      const cepInput = document.getElementById('cep');
      const valor = cepInput.value.replace(/\D/g, '');
      if (valor.length === 8) {
        fetch(`https://viacep.com.br/ws/${valor}/json/`)
          .then(r => r.json())
          .then(data => {
            if (!data.erro) {
              document.getElementById('rua').value = data.logradouro || '';
              document.getElementById('bairro').value = data.bairro || '';
              document.getElementById('cidade').value = data.localidade || '';
              document.getElementById('estado').value = data.uf || '';
              document.getElementById('numero').focus();
            } else {
              alert('CEP n√£o encontrado. Preencha manualmente.');
            }
          })
          .catch(() => alert('Erro ao buscar CEP. Preencha manualmente.'));
      }
    });

    // Antes do envio - interface
    form.addEventListener('submit', e => {
      submitButton.disabled = true;
      statusMessage.innerHTML = '‚è≥ Enviando dados e gerando contrato...';
      statusMessage.style.color = '#007bff';
      downloadArea.innerHTML = '';
      // N√£o preventDefault: queremos que o form seja enviado para o iframe
    });

    // Ao carregar o iframe (quando o servidor responde)
    iframe.onload = function () {
      try {
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        const responseText = iframeDoc.body.innerText.trim();
        if (!responseText) {
          // Em algumas situa√ß√µes o navegador retorna HTML (por exemplo quando /dev), ent√£o mostramos mensagem gen√©rica
          statusMessage.innerHTML = '‚ö†Ô∏è Resposta do servidor vazia ou n√£o-JSON. Verifique a implanta√ß√£o (/exec).';
          statusMessage.style.color = '#d9534f';
          submitButton.disabled = false;
          return;
        }

        // Tentar parsear JSON retornado pelo Apps Script
        const response = JSON.parse(responseText);

        if (response.success) {
          statusMessage.innerHTML = `‚úÖ ${response.message}`;
          statusMessage.style.color = '#28a745';
          downloadArea.innerHTML = `
            <a href="${response.docUrl}" target="_blank" class="button-link">üìÑ Ver Google Docs</a>
            <a href="${response.pdfUrl}" target="_blank" class="button-link">‚¨áÔ∏è Baixar PDF</a>
          `;
        } else {
          statusMessage.innerHTML = `‚ùå Erro: ${response.message}`;
          statusMessage.style.color = '#dc3545';
        }
      } catch (err) {
        console.error('Erro parseando resposta do iframe:', err);
        statusMessage.innerHTML = '‚ùå Erro ao processar a resposta do servidor.';
        statusMessage.style.color = '#dc3545';
      } finally {
        submitButton.disabled = false;
        form.reset();
      }
    };
  </script>
</body>
</html>
